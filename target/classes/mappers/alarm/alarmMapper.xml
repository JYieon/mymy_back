<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trip.mymy.mybatis.AlarmMapper">

    <!-- AlarmSettingsDTO ë§¤í•‘ -->
    <resultMap id="alarmSettingsResultMap" type="com.trip.mymy.dto.AlarmSettingsDTO">
        <id property="memberId" column="MEMBER_ID_PK"/>
        <result property="postAlarm" column="POST_ALARM" javaType="boolean"/>
        <result property="commentAlarm" column="COMMENT_ALARM" javaType="boolean"/>
        <result property="chatAlarm" column="CHAT_ALARM" javaType="boolean"/>
        <result property="followAlarm" column="FOLLOW_ALARM" javaType="boolean"/>
    </resultMap>

    <!-- AlarmDTO ë§¤í•‘ -->
    <resultMap id="alarmResultMap" type="com.trip.mymy.dto.AlarmDTO">
    	<id property="alarmNo" column="ALARM_NO_PK" />
    	<result property="senderId" column="SENDER_ID" />
    	<result property="createdAt" column="ALARM_CREATED_AT_DT" javaType="java.time.LocalDateTime"/>
    	<result property="memberId" column="MEMBER_ID_PK" />
    	<result property="alarmTypeId" column="ALARM_TYPE_ID_PK" javaType="int"/> 
    	<result property="alarmTypeName" column="ALARM_TYPE_NAME"/>
    	<result property="alarmContent" column="ALARM_CONTENT" /> 
	</resultMap>

    <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ì•ŒëžŒ ëª©ë¡ ì¡°íšŒ -->
    <select id="getUserAlarms" resultMap="alarmResultMap">
        SELECT A.*, T.ALARM_TYPE_NAME 
        FROM ALARM_TB A
        JOIN ALARM_TYPE_TB T ON A.ALARM_TYPE_ID_PK = T.ALARM_TYPE_ID_PK
        WHERE A.MEMBER_ID_PK = #{memberId}
        ORDER BY A.ALARM_CREATED_AT_DT DESC
    </select>
    
     <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ì•ŒëžŒ ëª©ë¡ ì¡°íšŒ (APIì—ì„œ ì‚¬ìš©) -->
    <select id="getAlarms" resultMap="alarmResultMap">
    SELECT 
        A.ALARM_NO_PK, 
        A.SENDER_ID, 
        A.ALARM_CREATED_AT_DT, 
        A.MEMBER_ID_PK, 
        A.ALARM_TYPE_ID_PK,
        T.ALARM_TYPE_NAME  <!-- ðŸ”¹ ì•ŒëžŒ íƒ€ìž…ëª… ì¶”ê°€ -->
    FROM ALARM_TB A
    JOIN ALARM_TYPE_TB T ON A.ALARM_TYPE_ID_PK = T.ALARM_TYPE_ID_PK
    WHERE A.MEMBER_ID_PK = #{userId}
    ORDER BY A.ALARM_CREATED_AT_DT DESC
</select>




    <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ì•ŒëžŒ ì„¤ì • ì¡°íšŒ -->
    <select id="getAlarmSettings" resultMap="alarmSettingsResultMap">
        SELECT * FROM ALARM_SETTINGS_TB WHERE MEMBER_ID_PK = #{memberId}
    </select>

    <!-- ì•ŒëžŒ ì„¤ì • ê¸°ë³¸ê°’ ì‚½ìž… (ì‚¬ìš©ìžê°€ ì„¤ì •ì´ ì—†ì„ ê²½ìš°) -->
    <insert id="insertDefaultAlarmSettings">
   	 	INSERT INTO ALARM_SETTINGS_TB (MEMBER_ID_PK, POST_ALARM, COMMENT_ALARM, CHAT_ALARM, FOLLOW_ALARM) 
    	VALUES (#{memberId}, 1, 1, 1, 1)
	</insert>
	

    <!-- ì•ŒëžŒ ì¶”ê°€ -->
    <insert id="insertAlarm">
    	INSERT INTO ALARM_TB (ALARM_NO_PK, SENDER_ID, ALARM_CREATED_AT_DT, MEMBER_ID_PK, ALARM_TYPE_ID_PK, IS_READ)
    	VALUES (ALARM_TB_SEQ.NEXTVAL, #{senderId}, SYSDATE, #{memberId}, #{alarmTypeId}, 0)
	</insert>


    <!-- ì•ŒëžŒ ìƒíƒœ ì—…ë°ì´íŠ¸ (STATUS ì»¬ëŸ¼ í™•ì¸ í•„ìš”) -->
    <update id="updateAlarmStatus">
        UPDATE ALARM_TB 
        SET STATUS = #{status} 
        WHERE ALARM_NO_PK = #{alarmNo}
    </update>
    
    <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ì•ŒëžŒ ì„¤ì • ì—…ë°ì´íŠ¸ -->
    <update id="updateAlarmSettings">
    UPDATE ALARM_SETTINGS_TB
    SET POST_ALARM = #{postAlarm},
        COMMENT_ALARM = #{commentAlarm},
        CHAT_ALARM = #{chatAlarm},
        FOLLOW_ALARM = #{followAlarm}
    WHERE MEMBER_ID_PK = #{memberId}
</update>
    

    <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ëª¨ë“  ì•ŒëžŒ ì‚­ì œ -->
    <delete id="deleteUserAlarms">
        DELETE FROM ALARM_TB WHERE MEMBER_ID_PK = #{memberId}
    </delete>
    
     <!-- íŠ¹ì • ì‚¬ìš©ìžì˜ ì½ì§€ ì•Šì€ ì•ŒëžŒ ê°œìˆ˜ ì¡°íšŒ -->
    <select id="getUnreadAlarmCount" resultType="int">
    	SELECT COUNT(*) FROM ALARM_TB WHERE MEMBER_ID_PK = #{memberId} AND IS_READ = 0
	</select>
    

</mapper>
