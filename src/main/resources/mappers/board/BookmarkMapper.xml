<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

    
    
<mapper namespace="com.trip.mymy.mybatis.BookmarkMapper">
	<resultMap type="com.trip.mymy.dto.BookmarkDTO" id="BOOKMARK_TB">
		<id property="bookNo" column="BOOK_NO_PK" />
		<result property="boardNo" column="BOARD_NO_PK" />
		<result property="id" column="MEMBER_ID_PK" />
		<result property="date" column="CREATE_DT"
			javaType="java.sql.Timestamp" />
		<result property="status" column="STATUS" />		
	</resultMap>
	
	<!-- BoardDTO와 매핑되는 resultMap 추가 -->
    <resultMap id="BOARD_TB" type="com.trip.mymy.dto.BoardDTO">
        <id property="boardNo" column="BOARD_NO_PK"/>
        <result property="id" column="MEMBER_ID_PK"/>
        <result property="title" column="BOARD_TITLE"/>
        <result property="content" column="BOARD_CONTENT"/>
        <result property="date" column="BOARD_DT" javaType="java.sql.Timestamp"/>
    </resultMap>
	
	<!-- 북마크 추가 -->
	<insert id="addBookmark">
    <!-- MERGE INTO: 기존 북마크가 존재하는지 확인 후, 있으면 UPDATE, 없으면 INSERT -->
    merge into BOOKMARK_TB B
    using (select #{id} as MEMBER_ID_PK, #{boardNo} as BOARD_NO_PK from dual) D
    on (B.MEMBER_ID_PK = D.MEMBER_ID_PK AND B.BOARD_NO_PK = D.BOARD_NO_PK)
    
    <!-- 이미 북마크가 존재하는 경우, STATUS를 1로 변경하여 활성화 -->
    when matched then
        update set B.STATUS = 1, B.CREATE_DT = SYSDATE
    
    <!-- 북마크한 적이 없는 경우, 새로운 북마크 추가 -->
    when not matched then
        insert (BOOK_NO_PK, MEMBER_ID_PK, BOARD_NO_PK, STATUS, CREATE_DT)
        values (BOOKMARK_TB_SEQ.NEXTVAL, #{id}, #{boardNo}, 1, SYSDATE)
</insert>
	
	<!-- 북마크 삭제 -->
	<delete id="deleteBookmark">
		delete from BOOKMARK_TB where MEMBER_ID_PK = #{id} and BOARD_NO_PK = #{boardNo}
	</delete>

	<!-- 북마크 확인 -->
	<select id="checkBookmark" resultType="int">
		select count(*) from BOOKMARK_TB where MEMBER_ID_PK = #{id} and BOARD_NO_PK = #{boardNo}
	</select>
	
	<!-- 사용자의 북마크 목록 조회 -->
<select id="getBookmarkList" resultMap="BOARD_TB">
    SELECT B.BOARD_NO_PK, B.BOARD_TITLE,B.BOARD_CONTENT, B.MEMBER_ID_PK, B.BOARD_DT
    FROM BOARD_TB B INNER JOIN BOOKMARK_TB BM ON B.BOARD_NO_PK = BM.BOARD_NO_PK  
    WHERE BM.MEMBER_ID_PK = 'a'
    AND BM.STATUS = 1  
    ORDER BY BM.CREATE_DT DESC
</select>
	
</mapper>